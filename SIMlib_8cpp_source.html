<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Adeon: src/utility/SIMlib.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Adeon
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('SIMlib_8cpp_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">SIMlib.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="SIMlib_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="SIMlib_8h.html">utility/SIMlib.h</a>&quot;</span></div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#ifdef HW_SERIAL</span></div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<a class="code" href="classGSM.html#a702ca153b5f6386c2dfcd1633bfdb864">GSM::GSM</a>(<span class="keywordtype">long</span> baud){</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="preprocessor">    #ifdef ESP32</span></div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;        Serial2.begin(DEFAULT_BAUD_RATE, SERIAL_8N1, RX, TX);</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="preprocessor">    #else</span></div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;        Serial2.begin(baud);</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="preprocessor">    #endif</span></div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;    _pSerialHandler = <span class="keyword">new</span> SerialHandler(&amp;Serial2);</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;    _pParser = <span class="keyword">new</span> ParserGSM(_pSerialHandler, &amp;_newMsg, &amp;_lastMsgIndex);</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;    _pPhoneBuffer = _pParser-&gt;getPointPhoneBuf();</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;}</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;</div><div class="line"><a name="l00049"></a><span class="lineno"><a class="line" href="classGSM.html#a702ca153b5f6386c2dfcd1633bfdb864">   49</a></span>&#160;<a class="code" href="classGSM.html#a702ca153b5f6386c2dfcd1633bfdb864">GSM::GSM</a>(uint8_t rx, uint8_t tx, <span class="keywordtype">long</span> baud) {</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;Stream *pGsmSerial = <span class="keyword">nullptr</span>;</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="preprocessor">#ifdef SW_SERIAL</span></div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="preprocessor">    #ifdef ESP8266</span></div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;        pGsmSerial = <span class="keyword">new</span> SoftwareSerial();</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;        ((SoftwareSerial*) pGsmSerial)-&gt;begin(baud, SWSERIAL_8N1, rx, tx, <span class="keyword">false</span>, RX_BUF_SIZE, 0);</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="preprocessor">    #else</span></div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;        pGsmSerial = <span class="keyword">new</span> SoftwareSerial(rx, tx);</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;        ((SoftwareSerial*) pGsmSerial)-&gt;begin(baud);</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="preprocessor">    #endif</span></div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="preprocessor">    #ifdef ESP32</span></div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;        Serial2.begin(baud, SERIAL_8N1, rx, tx);</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="preprocessor">    #else</span></div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;        Serial2.begin(baud);</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="preprocessor">    #endif</span></div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    pGsmSerial = &amp;Serial2;</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    _pSerialHandler = <span class="keyword">new</span> SerialHandler(pGsmSerial);</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    _pParser = <span class="keyword">new</span> ParserGSM(_pSerialHandler, &amp;_newMsg, &amp;_lastMsgIndex);</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    _pPhoneBuffer = _pParser-&gt;getPointPhoneBuf();   </div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;}</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;</div><div class="line"><a name="l00078"></a><span class="lineno"><a class="line" href="classGSM.html#a83e38f33a6023bd38b1d69623f91bb69">   78</a></span>&#160;<a class="code" href="classGSM.html#a702ca153b5f6386c2dfcd1633bfdb864">GSM::GSM</a>(Stream* pGsmSerial) {</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    _pSerialHandler = <span class="keyword">new</span> SerialHandler(pGsmSerial);</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    _pParser = <span class="keyword">new</span> ParserGSM(_pSerialHandler, &amp;_newMsg, &amp;_lastMsgIndex);</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    _pPhoneBuffer = _pParser-&gt;getPointPhoneBuf();   </div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;}</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;</div><div class="line"><a name="l00091"></a><span class="lineno"><a class="line" href="classGSM.html#a303477c96b0afa14020613040d21d008">   91</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classGSM.html#a303477c96b0afa14020613040d21d008">GSM::checkGsmOutput</a>(){</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    _pSerialHandler-&gt;periodicSerialCheck();</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    <span class="comment">//check if SMS is received</span></div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;    <span class="keywordflow">if</span>(_pSerialHandler-&gt;isRxBufferAvailable()){</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;        <span class="keywordflow">if</span>(_pParser-&gt;identifyIncomingMsg(incomingSms)){</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;            <span class="keywordflow">if</span>(sendCommand(_pParser-&gt;makeDynamicCmd(smsReading, _lastMsgIndex))){</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;                _pParser-&gt;getPhoneNumber();</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;                _pParser-&gt;getMsg();</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;                _pMsgBuffer = _pParser-&gt;getPointMsgBuf();</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;                <span class="keywordflow">if</span>(_lastMsgIndex &gt; 10){</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;                    deleteMsgGsmStack();</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;                }</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;                <span class="keywordflow">else</span>{</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;                    deleteMsg();</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;                }</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;            }</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;            <span class="keywordflow">else</span>{</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;                Serial.println(F(<span class="stringliteral">&quot;ERR&quot;</span>));</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;                deleteMsgGsmStack();</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;            }</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;        }</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    }</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    _pSerialHandler-&gt;setRxBufferAvailability(<span class="keyword">false</span>);</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;}</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;</div><div class="line"><a name="l00120"></a><span class="lineno"><a class="line" href="classGSM.html#a7b4c728a1dfd85b0edc3b456a95d25f8">  120</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classGSM.html#a7b4c728a1dfd85b0edc3b456a95d25f8">GSM::isNewMsgAvailable</a>(){</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    <span class="keywordflow">return</span> _newMsg;</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;}</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;</div><div class="line"><a name="l00128"></a><span class="lineno"><a class="line" href="classGSM.html#aad06a282ac20a1aa1cf7c0e9e3acefe3">  128</a></span>&#160;<span class="keywordtype">char</span>* <a class="code" href="classGSM.html#aad06a282ac20a1aa1cf7c0e9e3acefe3">GSM::getMsg</a>(){</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    _newMsg = <span class="keyword">false</span>; <span class="comment">//sms is returned, preparing logical variable for new msg</span></div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    <span class="keywordflow">return</span> _pMsgBuffer;</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;}</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;</div><div class="line"><a name="l00137"></a><span class="lineno"><a class="line" href="classGSM.html#a931dd2990253cf8a7fccb1b8afb2c379">  137</a></span>&#160;<span class="keywordtype">char</span>* <a class="code" href="classGSM.html#a931dd2990253cf8a7fccb1b8afb2c379">GSM::getPhoneNum</a>(){</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;    <span class="keywordflow">return</span> _pPhoneBuffer;</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;}</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;</div><div class="line"><a name="l00145"></a><span class="lineno"><a class="line" href="classGSM.html#aaa11bbbcec11956d7b7210ae7877d71f">  145</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classGSM.html#aaa11bbbcec11956d7b7210ae7877d71f">GSM::begin</a>(){</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    <span class="keywordflow">while</span>(sendCommand(basicCommand) != <span class="keyword">true</span>){</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;        delay(1000);</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        Serial.println(F(<span class="stringliteral">&quot;GSM IS OFFLINE&quot;</span>));</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    }</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    Serial.println(F(<span class="stringliteral">&quot;GSM IS ONLINE&quot;</span>));</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    delay(1000);</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;    <span class="keywordflow">while</span>(sendCommand(gsmMode) != <span class="keyword">true</span>){</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;        delay(1000);</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;        Serial.println(F(<span class="stringliteral">&quot;CONFIG FAILED&quot;</span>));</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    }</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    Serial.println(F(<span class="stringliteral">&quot;GSM IS CONFIGURED&quot;</span>));</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    delay(1000);</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    <span class="keywordflow">while</span>(sendCommand(plainTextMode) != <span class="keyword">true</span>){</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;        delay(1000);</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;        Serial.println(F(<span class="stringliteral">&quot;MSG SETTING FAILED&quot;</span>));</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    }</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    Serial.println(F(<span class="stringliteral">&quot;MSG SET TO TEXT&quot;</span>));</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    delay(1000);</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;}</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;<span class="keywordtype">bool</span> GSM::sendCommand(<span class="keyword">const</span> <span class="keywordtype">char</span>* cmd){</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    _pSerialHandler-&gt;serialWrite(cmd);</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    <span class="keywordflow">return</span> _pParser-&gt;getResponse(confirmFeedback);</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;}</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;<span class="keywordtype">void</span> GSM::deleteMsg(){</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    <span class="keywordflow">if</span>(sendCommand(_pParser-&gt;makeDynamicCmd(deleteSms, _lastMsgIndex))){</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;        Serial.println(F(<span class="stringliteral">&quot;MSG DELETED&quot;</span>));</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;        _lastMsgIndex--;</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    }</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    <span class="keywordflow">else</span>{</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;        Serial.println(F(<span class="stringliteral">&quot;DELETE ERR&quot;</span>));</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;    }</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;}</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;<span class="keywordtype">void</span> GSM::deleteMsgGsmStack(){</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    <span class="keywordflow">while</span>(_lastMsgIndex != 0){</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;        deleteMsg();</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    }</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;}</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;GSM::ParserGSM::ParserGSM(GSM::SerialHandler* pSerialHandler, <span class="keywordtype">bool</span>* newMsg, uint8_t* lastMsgIndex){</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    _pSerialHandler = pSerialHandler;</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    _pNewMsg = newMsg;</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    _pLastMsgIndex = lastMsgIndex;</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;}</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;<span class="keywordtype">bool</span> GSM::ParserGSM::getResponse(<span class="keyword">const</span> <span class="keywordtype">char</span>* searchedChar){</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    _pSerialHandler-&gt;feedbackSerialCheck();</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    _pRxBuffer = _pSerialHandler-&gt;getRxBufferP();</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    <span class="keywordflow">if</span>(_pSerialHandler-&gt;isRxBufferAvailable()){</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;        <span class="keywordflow">if</span>(strstr(_pRxBuffer, <span class="stringliteral">&quot;OK&quot;</span>) != <span class="keyword">nullptr</span>){</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;            _pSerialHandler-&gt;setRxBufferAvailability(<span class="keyword">false</span>);</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;        }</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        <span class="keywordflow">else</span>{</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;        }</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    }</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;}</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;<span class="keywordtype">void</span> GSM::ParserGSM::getMsg(){</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;    _pRxBuffer = _pSerialHandler-&gt;getRxBufferP();</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;    <span class="keywordtype">char</span>* tmpStr = strrchr(_pRxBuffer, <span class="charliteral">&#39;\&quot;&#39;</span>) + 3;</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    <span class="comment">//if semicolon is not present, message is not valid</span></div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;    <span class="keywordflow">if</span>(strrchr(tmpStr, <span class="charliteral">&#39;;&#39;</span>) != <span class="keyword">nullptr</span>){</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;        <span class="keywordtype">char</span>* endMsgPointer = strrchr(tmpStr, <span class="charliteral">&#39;;&#39;</span>) + 1;</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;        uint8_t counter = 0;</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;        <span class="keywordflow">if</span>(_msgBuffer != <span class="keyword">nullptr</span>){</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;            free(_msgBuffer);</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;        }</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;        _msgBuffer = (<span class="keywordtype">char</span>*)malloc(strlen(tmpStr) - strlen(endMsgPointer) + 1);</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;        <span class="keywordflow">while</span>(&amp;tmpStr[counter] != endMsgPointer){</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;            _msgBuffer[counter] = tmpStr[counter];</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;            counter++;</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;        }</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;        _msgBuffer[counter] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;        *_pNewMsg = <span class="keyword">true</span>;</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    }</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;}</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;<span class="keywordtype">void</span> GSM::ParserGSM::getPhoneNumber(){</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;    _pRxBuffer = _pSerialHandler-&gt;getRxBufferP();</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;    <span class="keywordtype">char</span>* tmpStr = strstr(_pRxBuffer, <span class="stringliteral">&quot;\&quot;+&quot;</span>) + 2;</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;    <span class="keywordtype">char</span>* endMsgPointer = strstr(tmpStr, <span class="stringliteral">&quot;\&quot;,\&quot;\&quot;,\&quot;&quot;</span>);</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;    uint8_t counter = 0;</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;    memset(_phoneBuffer, 0, <span class="keyword">sizeof</span>(_phoneBuffer));</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    <span class="keywordflow">while</span>(&amp;tmpStr[counter] != endMsgPointer){</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;        _phoneBuffer[counter] = tmpStr[counter];</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;        counter++;</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;    }</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;    _phoneBuffer[counter] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;}</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;<span class="keywordtype">char</span>* GSM::ParserGSM::getPointMsgBuf(){</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    <span class="keywordflow">return</span> _msgBuffer;</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;}</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;<span class="keywordtype">char</span>* GSM::ParserGSM::getPointPhoneBuf(){</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;    <span class="keywordflow">return</span> _phoneBuffer;</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;}</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;<span class="keywordtype">bool</span> GSM::ParserGSM::identifyIncomingMsg(<span class="keyword">const</span> <span class="keywordtype">char</span>* command){</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;    _pRxBuffer = _pSerialHandler-&gt;getRxBufferP();</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;    <span class="keywordtype">char</span> *tmpStr = strstr(_pRxBuffer, command);</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;    <span class="keywordflow">if</span>(tmpStr != <span class="keyword">nullptr</span>){</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;        <span class="keywordflow">if</span>(strncmp(tmpStr, incomingSms, strlen(incomingSms)) == 0){</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;            *_pLastMsgIndex = GetIndex(tmpStr, <span class="charliteral">&#39;,&#39;</span>);</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;            _pSerialHandler-&gt;setRxBufferAvailability(<span class="keyword">false</span>);</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;        }</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;    }</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;    _pSerialHandler-&gt;setRxBufferAvailability(<span class="keyword">false</span>);</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;    </div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;}</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;<span class="keywordtype">char</span>* GSM::ParserGSM::makeDynamicCmd(<span class="keyword">const</span> <span class="keywordtype">char</span>* command, uint8_t <span class="keywordtype">id</span>){</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;    <span class="keywordflow">if</span>(_cmdBuffer != <span class="keyword">nullptr</span>){</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;        free(_cmdBuffer);</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;    }</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;    <span class="comment">//+ 3 â€“ array cells for 2 digit number and end char</span></div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;    _cmdBuffer = (<span class="keywordtype">char</span>*)malloc(strlen(command) + 3);</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;    strcpy(_cmdBuffer, command);</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;    sprintf(&amp;_cmdBuffer[strlen(command)], <span class="stringliteral">&quot;%d&quot;</span>, <span class="keywordtype">id</span>);</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;    _cmdBuffer[strlen(command) + 2] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;    <span class="keywordflow">return</span> _cmdBuffer;</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;}</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;uint8_t GSM::ParserGSM::GetIndex(<span class="keywordtype">char</span>* buffer, <span class="keywordtype">char</span> startSym){</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;    <span class="keywordtype">char</span> *tmpStr = strchr(buffer, startSym) + 1;</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;    uint8_t indexLenCount = 0;</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;    <span class="keywordflow">while</span>(tmpStr[indexLenCount] &gt;= 0x31 &amp;&amp; tmpStr[indexLenCount] &lt;= 0x39){</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;        indexLenCount++;</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    }</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    tmpStr[indexLenCount] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;    <span class="keywordflow">return</span> (uint8_t)atoi(tmpStr);</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;}</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;GSM::SerialHandler::SerialHandler(Stream* pGsmSerial){</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    _pGsmSerial = pGsmSerial;</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;}</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;<span class="keywordtype">void</span> GSM::SerialHandler::serialWrite(<span class="keyword">const</span> <span class="keywordtype">char</span>* command){</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    _periodicReading = <span class="keyword">false</span>;</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    _pGsmSerial-&gt;println(command);</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    _pGsmSerial-&gt;flush();</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;    delay(200);</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;    _periodicReading = <span class="keyword">true</span>;</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;}</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;<span class="keywordtype">void</span> GSM::SerialHandler::periodicSerialCheck(){</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;    <span class="keywordflow">if</span>(_periodicReading){</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;        <span class="keywordflow">if</span>(_periodicReadingFlag){</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;            _lastReadTime = millis();</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;            _periodicReadingFlag = <span class="keyword">false</span>;</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;        }</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;        <span class="keywordflow">if</span>((millis() - _lastReadTime) &gt;= PERIODIC_READ_TIME){</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;            uint16_t var;</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;            var = _pGsmSerial-&gt;available();</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;            delay(100);</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;            <span class="keywordflow">if</span>(var &gt; 0 &amp;&amp; _periodicReading){</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;                serialRead(var);</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;            }</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;            _periodicReadingFlag = <span class="keyword">true</span>;</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;        }</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;    }</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;}</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;<span class="keywordtype">void</span> GSM::SerialHandler::feedbackSerialCheck(){</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> timeFlag = millis();</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;    <span class="keywordflow">while</span>(millis() &lt; (timeFlag + 1000)){</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;        uint16_t var;</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;        var = _pGsmSerial-&gt;available();</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;        delay(100);</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;        <span class="keywordflow">if</span>(var &gt; 0){</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;            serialRead(var);</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;        }</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;    }</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;}</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;<span class="keywordtype">char</span>* GSM::SerialHandler::getRxBufferP(){</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;    <span class="keywordflow">return</span> _rxBuffer;</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;}</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;<span class="keywordtype">bool</span> GSM::SerialHandler::isRxBufferAvailable(){</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;    <span class="keywordflow">return</span> _rxBufferAvailable;</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;}</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;<span class="keywordtype">void</span> GSM::SerialHandler::setRxBufferAvailability(<span class="keywordtype">bool</span> var){</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;    _rxBufferAvailable = var;</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;}</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;<span class="keywordtype">void</span> GSM::SerialHandler::serialRead(uint8_t incomingBytes){</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;    <span class="keywordflow">if</span>(_rxBuffer != <span class="keyword">nullptr</span>){</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;        free(_rxBuffer);</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;        _rxBuffer = <span class="keyword">nullptr</span>;</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;    }</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;    _rxBuffer = (<span class="keywordtype">char</span>*)malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>) * (incomingBytes + 1));</div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;    _pGsmSerial-&gt;readBytes(_rxBuffer, incomingBytes);</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;    _rxBuffer[incomingBytes] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;    _rxBufferAvailable = <span class="keyword">true</span>;</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;}</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;</div><div class="ttc" id="classGSM_html_a7b4c728a1dfd85b0edc3b456a95d25f8"><div class="ttname"><a href="classGSM.html#a7b4c728a1dfd85b0edc3b456a95d25f8">GSM::isNewMsgAvailable</a></div><div class="ttdeci">bool isNewMsgAvailable()</div><div class="ttdoc">Returns new message availability. </div><div class="ttdef"><b>Definition:</b> <a href="SIMlib_8cpp_source.html#l00120">SIMlib.cpp:120</a></div></div>
<div class="ttc" id="classGSM_html_aad06a282ac20a1aa1cf7c0e9e3acefe3"><div class="ttname"><a href="classGSM.html#aad06a282ac20a1aa1cf7c0e9e3acefe3">GSM::getMsg</a></div><div class="ttdeci">char * getMsg()</div><div class="ttdoc">Returns pointer to message buffer array. </div><div class="ttdef"><b>Definition:</b> <a href="SIMlib_8cpp_source.html#l00128">SIMlib.cpp:128</a></div></div>
<div class="ttc" id="classGSM_html_a702ca153b5f6386c2dfcd1633bfdb864"><div class="ttname"><a href="classGSM.html#a702ca153b5f6386c2dfcd1633bfdb864">GSM::GSM</a></div><div class="ttdeci">GSM(uint8_t rx, uint8_t tx, long baud=DEFAULT_BAUD_RATE)</div><div class="ttdoc">Constructor for the class GSM. </div><div class="ttdef"><b>Definition:</b> <a href="SIMlib_8cpp_source.html#l00049">SIMlib.cpp:49</a></div></div>
<div class="ttc" id="classGSM_html_a931dd2990253cf8a7fccb1b8afb2c379"><div class="ttname"><a href="classGSM.html#a931dd2990253cf8a7fccb1b8afb2c379">GSM::getPhoneNum</a></div><div class="ttdeci">char * getPhoneNum()</div><div class="ttdoc">Returns pointer to phone number buffer array. </div><div class="ttdef"><b>Definition:</b> <a href="SIMlib_8cpp_source.html#l00137">SIMlib.cpp:137</a></div></div>
<div class="ttc" id="classGSM_html_a303477c96b0afa14020613040d21d008"><div class="ttname"><a href="classGSM.html#a303477c96b0afa14020613040d21d008">GSM::checkGsmOutput</a></div><div class="ttdeci">void checkGsmOutput()</div><div class="ttdoc">Checks for incoming SMS. Checks serial for new incoming message. If message is detected, it starts to checks its validity. If message is valid phone number and message text are parsed. When the message is processed, SMS is deleted from GSM buffer. If GSM buffer keeps more than 10 SMS, whole buffer will be deleted. </div><div class="ttdef"><b>Definition:</b> <a href="SIMlib_8cpp_source.html#l00091">SIMlib.cpp:91</a></div></div>
<div class="ttc" id="classGSM_html_aaa11bbbcec11956d7b7210ae7877d71f"><div class="ttname"><a href="classGSM.html#aaa11bbbcec11956d7b7210ae7877d71f">GSM::begin</a></div><div class="ttdeci">void begin()</div><div class="ttdoc">Sets GSM module. Performs standard AT test, sets GSM mode and message in plain text. </div><div class="ttdef"><b>Definition:</b> <a href="SIMlib_8cpp_source.html#l00145">SIMlib.cpp:145</a></div></div>
<div class="ttc" id="SIMlib_8h_html"><div class="ttname"><a href="SIMlib_8h.html">SIMlib.h</a></div><div class="ttdoc">Adeon library for GSM modules. </div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_0619a8f54b4fad7043a6de45be8fde0b.html">utility</a></li><li class="navelem"><a class="el" href="SIMlib_8cpp.html">SIMlib.cpp</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
